<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络管理系统</title>

    <!-- 外部资源引入 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>

    <style>
        /* 保持所有原有样式 */
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: #f0f2f5 url('https://images8.alphacoders.com/134/1347375.png') no-repeat center center fixed;
            background-size: cover;
        }

        .sidebar {
            height: 100vh;
            background-color: rgba(0, 21, 41, 0.7);
            color: white;
            transition: all 0.3s;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(24, 144, 255, 0.5);
        }

        .content {
            padding: 20px;
        }

        .content-section {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #main-title {
            font-size: 48px;
            color: #1890ff;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .author {
            font-size: 18px;
            color: #666;
            margin-top: 10px;
        }

        #dataTable table tr:hover td {
            background-color: rgba(255, 223, 186, 0.5);
            transition: background-color 0.3s;
        }

        #mybtn {
            background-color: #1890ff;
            border: none;
            color: white;
            padding: 10px 20px;
            margin: 5px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 5px;
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        #mybtn:hover {
            background-color: #40a9ff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .stat-card {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
        }

        .stat-label {
            font-size: 16px;
            color: #666;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }

        /* 拓扑图容器样式 */
        #topology-container {
            width: 100%;
            height: 600px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
<div class="container-fluid">
    <div class="row">
        <!-- 侧边栏 -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#system-overview">
                            <i class="bi bi-house-door"></i> 系统概览
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#topology-view">
                            <i class="bi bi-diagram-3"></i> 网络拓扑
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#alarm-management">
                            <i class="bi bi-exclamation-triangle"></i> 告警管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#device-management">
                            <i class="bi bi-hdd-stack"></i> 设备管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#performance-monitor">
                            <i class="bi bi-graph-up"></i> 性能监控
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- 主要内容区 -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="content">
                <!-- 系统概览 -->
                <div id="system-overview" class="content-section">
                    <h1 id="main-title" class="text-center">网络管理平台</h1>
                    <p class="text-center author">作者：winiymissl-bochen</p>
                </div>

                <!-- 网络拓扑 -->
                <div id="topology-view" class="content-section" style="display: none;">
                    <h2>网络拓扑</h2>
                    <div id="topology-container"></div>
                </div>

                <!-- 告警管理 -->
                <div id="alarm-management" class="content-section" style="display: none;">
                    <h2>告警管理</h2>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-value" id="healthScore">-</div>
                                <div class="stat-label">健康评分</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-value" id="healthyDevices">-/-</div>
                                <div class="stat-label">健康设备/总设备</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-value" id="unhealthyDevices">-</div>
                                <div class="stat-label">不健康设备数</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container" id="categoryChart"></div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container" id="healthDistributionChart"></div>
                        </div>
                    </div>
                </div>

                <!-- 设备管理 -->
                <div id="device-management" class="content-section" style="display: none;">
                    <h2>设备列表</h2>
                    <form>
                        <div class="form-group form-inline" style="margin-bottom:10px;">
                            <div class="d-flex align-items-center">
                                <button type="button" onclick="load()" id="mybtn" class="btn btn-primary me-2">
                                    加载设备
                                </button>
                                <select name="sizeMenu" id="sizeMenu" class="form-select" style="width:150px;">
                                    <option value="-1">全部</option>
                                    <option value="5">5 项</option>
                                    <option value="20">20 项</option>
                                    <option value="0">空</option>
                                </select>
                            </div>
                        </div>
                    </form>
                    <div id="dataTable" class="table-responsive">
                        <!-- 表格内容将在加载设备后动态填充 -->
                    </div>
                </div>

                <!-- 性能监控 -->
                <div id="performance-monitor" class="content-section" style="display: none;">
                    <h2>性能监控</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container" id="interfaceStatusChart"></div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container" id="interfaceSpeedChart"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="chart-container" id="interfaceTrafficChart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- 模态框 -->
<div class="modal fade" id="deviceModal" tabindex="-1" aria-labelledby="deviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deviceModalLabel">设备详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>主机名:</strong> <span id="modal-hostname"></span></p>
                        <p><strong>家族:</strong> <span id="modal-family"></span></p>
                        <p><strong>类型:</strong> <span id="modal-type"></span></p>
                        <p><strong>IP 地址:</strong> <span id="modal-ip"></span></p>
                        <p><strong>时间:</strong> <span id="modal-time"></span></p>
                        <p><strong>角色:</strong> <span id="modal-role"></span></p>
                        <p><strong>状态:</strong> <span id="modal-stat"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>UUID:</strong> <span id="modal-uuid"></span></p>
                        <p><strong>MAC 地址:</strong> <span id="modal-mac"></span></p>
                        <p><strong>软件类型:</strong> <span id="modal-softwareType"></span></p>
                        <p><strong>软件版本:</strong> <span id="modal-softwareVersion"></span></p>
                        <p><strong>最后更新时间:</strong> <span id="modal-lastUpdated"></span></p>
                        <p><strong>序列号:</strong> <span id="modal-serialNumber"></span></p>
                        <p><strong>内存大小:</strong> <span id="modal-memorySize"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
    let myDeviceData = [];
    let myHealthData = {};
    let interfaceStatusChart;
    let interfaceSpeedChart;
    let interfaceTrafficChart;
    let interfaceData = {};
    let categoryChart;
    let healthDistributionChart;
    let topologyChart;

    $(document).ready(function() {
        $('.nav-link').on('click', function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            var target = $(this).attr('href');
            $('.content-section').hide();
            $(target).show();

            if (target === '#topology-view') {
                if (!topologyChart) {
                    topologyChart = echarts.init(document.getElementById('topology-container'));
                }
                loadTopologyData();
            } else if (target === '#alarm-management') {
                initAlarmCharts();
                loadHealth();
                {#setInterval(loadHealth, 3000);#}
            } else if (target === '#performance-monitor') {
                initInterfaceCharts();
                loadInterfaceData();
                setInterval(loadInterfaceData, 3000);
            }
        });
    });

    // 新增拓扑图相关函数
    function loadTopologyData() {
        $.ajax({
            url: "http://127.0.0.1:5000/get_topology",
            type: "GET",
            dataType: "json",
            success: function(response) {
                updateTopologyChart(response.data);
            },
            error: function() {
                console.error('加载拓扑数据失败');
            }
        });
    }

    function updateTopologyChart(data) {
        const option = {
            title: {
                text: '网络拓扑图',
                subtext: '设备总数: ' + data.statistics.total_devices,
                left: 'center',
                textStyle: {
                    fontSize: 24,
                    fontWeight: 'bold',
                    color: '#1890ff'
                }
            },
            tooltip: {
                formatter: function(params) {
                    if (params.dataType === 'node') {
                        return `设备名称: ${params.data.name}<br/>类型: ${params.data.type}<br/>IP: ${params.data.ip || '未知'}<br/>状态: ${params.data.status || '正常'}`;
                    }
                    return '';
                }
            },
            series: [{
                type: 'graph',
                layout: 'force',
                symbol: 'image://https://img.icons8.com/color/96/000000/network-switch.png', // 使用交换机图标
                symbolSize: [48, 48], // 调整图标大小
                roam: true,
                label: {
                    show: true,
                    position: 'bottom',
                    formatter: '{b}',
                    fontSize: 12,
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    padding: [4, 8],
                    borderRadius: 4
                },
                edgeSymbol: ['circle', 'arrow'],
                edgeSymbolSize: [4, 10],
                edgeLabel: {
                    fontSize: 12
                },
                force: {
                    repulsion: 1000,
                    gravity: 0.1,
                    edgeLength: 200,
                    layoutAnimation: true
                },
                data: data.nodes.map(node => ({
                    ...node,
                    symbol: node.type === 'router' ? 'image://https://img.icons8.com/color/96/000000/router.png' :
                        node.type === 'switch' ? 'image://https://img.icons8.com/color/96/000000/network-switch.png' :
                            'image://https://img.icons8.com/color/96/000000/computer.png',
                    symbolSize: [48, 48],
                    itemStyle: {
                        color: node.type === 'router' ? '#ff4d4f' :
                            node.type === 'switch' ? '#1890ff' : '#52c41a',
                        borderColor: '#fff',
                        borderWidth: 2,
                        shadowColor: 'rgba(0, 0, 0, 0.3)',
                        shadowBlur: 10
                    }
                })),
                links: data.links.map(link => ({
                    ...link,
                    lineStyle: {
                        color: link.status === 'down' ? '#ff4d4f' : '#8c8c8c',
                        width: link.bandwidth ? Math.log(link.bandwidth) : 2,
                        type: link.type === 'wireless' ? 'dashed' : 'solid',
                        curveness: 0.2,
                        shadowColor: 'rgba(0, 0, 0, 0.3)',
                        shadowBlur: 5
                    }
                })),
                emphasis: {
                    focus: 'adjacency',
                    lineStyle: {
                        width: 4
                    }
                }
            }]
        };

        topologyChart.setOption(option);
    }

    function initAlarmCharts() {
        categoryChart = echarts.init(document.getElementById('categoryChart'));
        healthDistributionChart = echarts.init(document.getElementById('healthDistributionChart'));
    }

    function loadHealth() {
        $.ajax({
            url: "http://127.0.0.1:5000/get_device_health",
            type: "GET",
            dataType: "json",
            success: function(res) {
                myHealthData = res;
                updateAlarmManagement(myHealthData);
            },
            error: function() {
                console.error('请求失败');
                $("#alarm-management").html("<p class='text-danger'>加载健康数据失败，请稍后重试。</p>");
            }
        });
    }

    function updateAlarmManagement(data) {
        $("#healthScore").text(data.latestHealthScore);
        $("#healthyDevices").text(data.monitoredHealthyDevices + "/" + data.totalDevices);
        $("#unhealthyDevices").text(data.monitoredUnHealthyDevices);

        updateCategoryChart(data.healthDistirubution);
        updateHealthDistributionChart(data.healthDistirubution);
    }

    function updateCategoryChart(healthDistribution) {
        var option = {
            title: {
                text: '设备类别健康分布',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                left: 10,
                data: healthDistribution.map(item => item.category)
            },
            series: [
                {
                    name: '设备类别',
                    type: 'pie',
                    radius: ['50%', '70%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '18',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: healthDistribution.map(item => ({
                        value: item.totalCount,
                        name: item.category
                    }))
                }
            ]
        };
        categoryChart.setOption(option);
    }

    function updateHealthDistributionChart(healthDistribution) {
        var option = {
            title: {
                text: '设备健康状态分布',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                left: 10,
                data: ['良好', '一般', '较差', '无健康数据']
            },
            series: [
                {
                    name: '健康状态',
                    type: 'pie',
                    radius: ['50%', '70%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '18',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: [
                        {value: healthDistribution.reduce((sum, item) => sum + item.goodCount, 0), name: '良好'},
                        {value: healthDistribution.reduce((sum, item) => sum + item.fairCount, 0), name: '一般'},
                        {value: healthDistribution.reduce((sum, item) => sum + item.badCount, 0), name: '较差'},
                        {value: healthDistribution.reduce((sum, item) => sum + item.noHealthCount, 0), name: '无健康数据'}
                    ]
                }
            ]
        };
        healthDistributionChart.setOption(option);
    }

    function load() {
        getDeviceList();
    }

    function getDeviceList() {
        $.ajax({
            url: "http://127.0.0.1:5000/getDeviceFromDNAC",
            type: "GET",
            dataType: "json",
            success: function(res) {
                myDeviceData = res;
                renderDeviceTable(myDeviceData);
            },
            error: function() {
                console.error('请求失败');
                $("#dataTable").html("<p class='text-danger'>加载设备数据失败，请稍后重试。</p>");
            }
        });
    }

    function renderDeviceTable(data) {
        let tableContent = `
                <table class='table table-striped table-hover'>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>主机名</th>
                            <th>家族</th>
                            <th>软件类型</th>
                            <th>内存</th>
                            <th>更新时间</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
        data.forEach(function(item) {
            tableContent += `
                    <tr data-uuid="${item.uuid}">
                        <td>${item.id}</td>
                        <td>${item.hostname}</td>
                        <td>${item.family}</td>
                        <td>${item.softwareType}</td>
                        <td>${item.memory}</td>
                        <td>${item.lastUpdated}</td>
                    </tr>
                `;
        });
        tableContent += "</tbody></table>";
        $("#dataTable").html(tableContent);

        $('#dataTable tbody tr').on('click', function() {
            const uuid = $(this).data('uuid');
            const device = myDeviceData.find(item => item.uuid === uuid);
            if (device) {
                updateModalContent(device);
                new bootstrap.Modal(document.getElementById('deviceModal')).show();
            }
        });
    }

    function updateModalContent(device) {
        $("#modal-hostname").text(device.hostname);
        $("#modal-family").text(device.family);
        $("#modal-type").text(device.type);
        $("#modal-ip").text(device.ip);
        $("#modal-time").text(device.time);
        $("#modal-role").text(device.role);
        $("#modal-stat").text(device.stat);
        $("#modal-uuid").text(device.uuid);
        $("#modal-mac").text(device.mac);
        $("#modal-softwareType").text(device.softwareType);
        $("#modal-softwareVersion").text(device.softwareVersion);
        $("#modal-lastUpdated").text(device.lastUpdated);
        $("#modal-serialNumber").text(device.serialNumber);
        $("#modal-memorySize").text(device.memory);
    }

    function initInterfaceCharts() {
        interfaceStatusChart = echarts.init(document.getElementById('interfaceStatusChart'));
        interfaceSpeedChart = echarts.init(document.getElementById('interfaceSpeedChart'));
        interfaceTrafficChart = echarts.init(document.getElementById('interfaceTrafficChart'));
    }

    function loadInterfaceData() {
        $.ajax({
            url: "http://127.0.0.1:5000/get_interface_data",
            type: "GET",
            dataType: "json",
            success: function(res) {
                // 为每个接口的数据添加一些随机波动
                Object.keys(res.data.interfaces).forEach(intf => {
                    res.data.interfaces[intf].in_bytes *= (1 + Math.random() * 0.2 - 0.1);  // ±10%的随机波动
                    res.data.interfaces[intf].out_bytes *= (1 + Math.random() * 0.2 - 0.1); // ±10%的随机波动
                });
                updateInterfaceCharts(res.data);
            },
            error: function() {
                console.error('请求失败');
                $("#performance-monitor").append("<p class='text-danger'>加载接口数据失败，请稍后重试。</p>");
            }
        });
    }

    function updateInterfaceCharts(data) {
        var interfaces = Object.keys(data.interfaces);
        var currentTime = new Date();

        interfaces.forEach(intf => {
            if (!interfaceData[intf]) {
                interfaceData[intf] = {
                    status: [],
                    speed: [],
                    inData: [],
                    outData: [],
                    times: []
                };
            }

            interfaceData[intf].status.push([currentTime, data.interfaces[intf].status === 'up' ? 1 : 0]);
            interfaceData[intf].speed.push([currentTime, data.interfaces[intf].speed / 1000000]); // 转换为Mbps
            interfaceData[intf].inData.push([currentTime, (data.interfaces[intf].in_bytes * 8) / 1000000]); // 转换为Mbps
            interfaceData[intf].outData.push([currentTime, (data.interfaces[intf].out_bytes * 8) / 1000000]); // 转换为Mbps

            // 保持最近的 60 个数据点（5分钟的数据，每5秒更新一次）
            if (interfaceData[intf].status.length > 60) {
                interfaceData[intf].status.shift();
                interfaceData[intf].speed.shift();
                interfaceData[intf].inData.shift();
                interfaceData[intf].outData.shift();
            }
        });

        updateInterfaceStatusChart(interfaces);
        updateInterfaceSpeedChart(interfaces);
        updateInterfaceTrafficChart(interfaces);
    }

    function updateInterfaceStatusChart(interfaces) {
        var option = {
            title: {
                text: '接口状态',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    var time = new Date(params[0].value[0]).toLocaleTimeString();
                    return time + '<br/>' + params[0].seriesName + ': ' + (params[0].value[1] === 1 ? '启用' : '禁用');
                }
            },
            legend: {
                data: interfaces,
                bottom: 0
            },
            xAxis: {
                type: 'time',
                splitLine: {
                    show: false
                }
            },
            yAxis: {
                type: 'value',
                max: 1,
                min: 0
            },
            series: interfaces.map(intf => ({
                name: intf,
                type: 'line',
                data: interfaceData[intf].status,
                step: 'end'
            }))
        };
        interfaceStatusChart.setOption(option);
    }

    function updateInterfaceSpeedChart(interfaces) {
        var option = {
            title: {
                text: '接口速度',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    var time = new Date(params[0].value[0]).toLocaleTimeString();
                    return time + '<br/>' + params[0].seriesName + ': ' + params[0].value[1] + ' Mbps';
                }
            },
            legend: {
                data: interfaces,
                bottom: 0
            },
            xAxis: {
                type: 'time',
                splitLine: {
                    show: false
                }
            },
            yAxis: {
                type: 'value',
                name: 'Mbps'
            },
            series: interfaces.map(intf => ({
                name: intf,
                type: 'line',
                data: interfaceData[intf].speed
            }))
        };
        interfaceSpeedChart.setOption(option);
    }

    function updateInterfaceTrafficChart(interfaces) {
        var option = {
            title: {
                text: '接口流量',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            legend: {
                data: interfaces.flatMap(intf => [intf + ' 入站', intf + ' 出站']),
                bottom: 0
            },
            xAxis: {
                type: 'time',
                boundaryGap: false,
            },
            yAxis: {
                type: 'value',
                name: '流量 (Mbps)'
            },
            series: interfaces.flatMap(intf => [
                {
                    name: intf + ' 入站',
                    type: 'line',
                    data: interfaceData[intf].inData
                },
                {
                    name: intf + ' 出站',
                    type: 'line',
                    data: interfaceData[intf].outData
                }
            ])
        };
        interfaceTrafficChart.setOption(option);
    }
</script>
</body>
</html>